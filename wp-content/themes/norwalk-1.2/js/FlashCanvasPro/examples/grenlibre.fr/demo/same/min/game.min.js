!function(){var n=window.game={};n.Grid=function(){var n,t=null,e=function(t,e){var i=n[t];if(null==i)return!1;var r=i[e];return null==r?!1:!0},i=function(t,i,r){return e(t,i)&&n[t][i]==r},r=function(t,e){var r=n[t][e];return i(t,e-1,r)||i(t,e+1,r)||i(t+1,e,r)||i(t-1,e,r)},o=function(n){var t=[];for(var e in n)null!=n[e]&&t.push(n[e]);return t};return{generate:function(e,i,r){t={x:e,y:i},n=[];for(var o=0;o<t.x;++o){n[o]=[];for(var a=n[o],l=0;l<t.y;++l)a[l]=Math.floor(r*Math.random())}return n},noMoreDestroyable:function(){for(var t in n)for(var e in n[t])if(r(t,e))return!1;return!0},isDestroyable:function(n,t){return e(n,t)&&r(n,t)},computeGravity:function(){for(var i={horizontal:[],vertical:[]},r=0;r<n.length;++r)i.vertical[r]=[],i.horizontal[r]=0;for(var r=0;r<n.length;++r){for(var o=n[r],a=!0,l=0;l<o.length&&a;++l)null!=o[l]&&(a=!1);if(a)for(var u=r+1;u<n.length;)u>r&&--i.horizontal[u],++u;else for(var c=0,f=0;f<t.y;++f)e(r,f)?c&&i.vertical[r].push({y:f,dy:c}):++c}return i},computeDestroy:function(t,i){if(!e(t,i)||!r(t,i))return[];var o=[],a=function(t,i,r){if(e(t,i)&&n[t][i]==r){for(var l=0;l<o.length;++l)if(o[l].x==t&&o[l].y==i)return;o.push({x:t,y:i}),a(t,i-1,r),a(t,i+1,r),a(t-1,i,r),a(t+1,i,r)}};return a(t,i,n[t][i]),o},applyDestroy:function(t){for(var e in t)n[t[e].x][t[e].y]=null},applyMoveVertical:function(){for(var t in n)n[t]=o(n[t])},applyMoveHorizontal:function(){for(var t in n)0==n[t].length&&(n[t]=null);n=o(n)},getColumns:function(){return n},getColumn:function(t){return n[t]||[]},getValue:function(t,e){return null!=n[t]?n[t][e]:null}}}(),n.CanvasBack=function(){var t,e;return{init:function(){t=$("#sameGameBack")[0],"object"==typeof FlashCanvas&&FlashCanvas.initElement(t),e=t.getContext("2d")},clean:function(){e.clearRect(0,0,t.width,t.height)},updateSize:function(){var n=$("#sameGame");$("#sameGameBack").css({left:n.offset().left,top:n.offset().top}),t.width=n.width(),t.height=n.height()},drawHover:function(t){var i=n.Canvas.getBrickSize(),r=n.Canvas.getGridSize();e.fillStyle="#fff",e.save(),e.scale(i.w,i.h);for(var o in t)e.beginPath(),e.arc(.5+t[o].x,.5+r.h-1-t[o].y,.49,0,2*Math.PI,!0),e.fill();e.restore()}}}(),$(document).ready(n.CanvasBack.init),n.Canvas=function(){var t,e,i,r,o,a={w:0,h:0},l={w:0,h:0},u={w:0,h:0},c=["#D34040","#82D340","#40C2D3","#8B40D3","#D3C840"],f=!0,v=null,s=function(n,t){return{x:n*u.w,y:(a.h-t-1)*u.h}},h=function(n){$(t).css("cursor",n?"pointer":"default")},d=function(n){n||m(),r=n?!0:!1},g=function(t,i){if(!f)return n.Grid.applyMoveVertical(),n.Grid.applyMoveHorizontal(),i(),void 0;var r,o=200,a=150,l=[],v=!1,h=0,d=function(){var f=new Date;if(f-r>o+a)n.Grid.applyMoveHorizontal(),i(t);else{setTimeout(d,30);for(var g in l){var y=l[g];e.clearRect(y.x,y.y,u.w,u.h)}l=[];var p,m;if(o>f-r){p=0,m=0==h?0:(f-r)/o;for(var w in t.vertical){var C=t.vertical[w];for(var $ in C){var x=n.Grid.getValue(w,C[$].y);if(null!=x){e.fillStyle=c[x];var G=C[$].y-C[$].dy*m,y=s(w,G);l.push(y),k(y.x,y.y)}}}}else{if(!v){v=!0,h=0,l=[],n.Grid.applyMoveVertical();for(var w in t.vertical){var C=t.vertical[w];for(var $ in C){var G=C[$].y-C[$].dy,x=n.Grid.getValue(w,G);if(null!=x){e.fillStyle=c[x];var y=s(w,G);k(y.x,y.y)}}}}p=0==h?0:(f-r-o)/a,m=1;for(var $=0;$<t.horizontal.length;++$){var C=t.horizontal[$];if(C)for(var b=n.Grid.getColumn($),w=$+C*p,G=0;G<b.length;++G){var D=b[G];e.fillStyle=c[D];var y=s(w,G);l.push(y),k(y.x,y.y)}}}}++h};r=(new Date).getTime(),d()},y=function(n,t){if(!f)return t(n);var i=(new Date).getTime(),r=100,o=0,a=function(){var l=(new Date).getTime();if(l-i>r)e.globalAlpha=1,t(n);else{setTimeout(a,30),e.fillStyle=$("body").css("background-color");var c=(l-i)/r;e.globalAlpha=c-o;for(var f in n){var v=s(n[f].x,n[f].y);e.fillRect(v.x,v.y,u.w,u.h)}o=c}};a()};g_onCanvasClick_isRunning=!1;var p=function(e){if(!g_onCanvasClick_isRunning){g_onCanvasClick_isRunning=!0;var i=e.clientX-$(t).position().left,r=e.clientY-$(t).position().top+$().scrollTop(),l=Math.floor(i/u.w),c=Math.floor(a.h-r/u.h);if(n.Grid.isDestroyable(l,c)){var f=(n.Grid.getColumns(),null!=v&&null!=o&&o.x==l&&o.y==c?v:n.Grid.computeDestroy(l,c));d(!1),y(f,function(e){x(e),n.Grid.applyDestroy(e),g(n.Grid.computeGravity(),function(){d(!0),G(),g_onCanvasClick_isRunning=!1,n.Grid.noMoreDestroyable()?_():$(t).one("click",p)})})}else g_onCanvasClick_isRunning=!1,$(t).one("click",p)}},m=function(){r&&(n.CanvasBack.clean(),o=null)},w=function(e){if(r){var i=e.clientX-$(t).position().left,l=e.clientY-$(t).position().top+$().scrollTop(),c={x:Math.floor(i/u.w),y:Math.floor(a.h-l/u.h)};o&&o.x==c.x&&o.y==c.y||(o=c,v=n.Grid.computeDestroy(c.x,c.y),n.CanvasBack.clean(),n.CanvasBack.drawHover(v))}},C=function(){v=null,$(t).mouseout(m),$(t).mousemove(w),n.CanvasBack.drawHover()},x=function(n){for(b in n){var t=s(n[b].x,n[b].y);e.clearRect(t.x,t.y,u.w,u.h)}},G=function(){e.clearRect(0,0,t.width,t.height);for(var i=n.Grid.getColumns(),r=0;r<i.length;++r)for(var o=i[r],a=0;a<o.length;++a)if(null!=o[a]){e.fillStyle=c[o[a]];var l=s(r,a);k(l.x,l.y)}},k=function(n,t){e.save(),e.translate(n,t),e.scale(u.w,u.h),e.clearRect(0,0,1,1),e.beginPath(),e.arc(.5,.5,.4,0,2*Math.PI,!0),e.fill(),e.restore()},D=function(){u={w:l.w/a.w,h:l.h/a.h}},z=function(){t.width=$(window).width()-5,t.height=$(window).height()-$("#optionsContainer").height()-42,l={w:$(t).width(),h:$(t).height()},D(),n.CanvasBack.updateSize()},M=function(){f=$("#animation").is(":checked")},S=function(){i=parseInt($("#colorNumber option:selected").val())},B=function(){var n=$("#gridSize option:selected").text(),t=n.indexOf("x");a={w:parseInt(n.substring(0,t)),h:parseInt(n.substring(t+1))},D(),R()},R=function(){$(t).unbind("click"),$(t).one("click",p),h(!1),d(!0),n.Grid.generate(a.w,a.h,i),G()},_=function(){d(!1),e.fillStyle="#fff",e.font="bold 40px serif",e.textBaseline="middle";var i=0==n.Grid.getColumns().length?"you win !":"you lose !";e.fillText(i,(l.w-e.measureText(i).width)/2,l.h/2),h(!0),$(t).one("click",R)};return{init:function(){t=document.getElementById("sameGame"),"object"==typeof FlashCanvas&&FlashCanvas.initElement(t),e=t.getContext("2d"),z(),$(window).resize(function(){z(),G()});for(var n=3;n<=c.length;++n)$("#colorNumber").append('<option value="'+n+'">'+n+"</option>");M(),S(),B(),$("#animation").change(function(){M()}),$("#colorNumber").change(function(){S(),R()}),$("#gridSize").change(function(){B(),R()}),C(),R()},getBrickSize:function(){return u},getGridSize:function(){return a}}}(),$(document).ready(n.Canvas.init)}();